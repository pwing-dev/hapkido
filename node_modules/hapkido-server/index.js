process.env['SUPPRESS_NO_CONFIG_WARNING'] = 'y';
const config       = require('config');
const createServer = require('./lib/server');

const defaults     = require('./config-defaults.json');
const packageName  = 'hapkido-server';
const cfg          = key => config.get(`${packageName}.${key}`);

if (require.main === module) {
  config.util.setModuleDefaults(packageName, defaults);
  // called directly from cli
  createServer().then(
    app => app.listen(cfg('port')),
    error => { console.error(error); process.exit(1); }
  );
} else {
  // required by other file
  // give the requirer the possibility to pass config options
  module.exports = configs => {
    if (configs) {
      config.util.extendDeep(defaults, configs);
    }
    config.util.setModuleDefaults(packageName, defaults);
    return createServer();
  };
}
